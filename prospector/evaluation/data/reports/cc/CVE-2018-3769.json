{
    "advisory_record": {
        "cve_id": "CVE-2018-3769",
        "description": "ruby-grape ruby gem suffers from a cross-site scripting (XSS) vulnerability via \"format\" parameter.",
        "reserved_timestamp": 1514419200,
        "published_timestamp": 1530806400,
        "updated_timestamp": 1530806221,
        "repository_url": null,
        "references": {
            "": 180,
            "commit::6876b71efc7b03f7ce1be3f075eaa4e7e6de19af": 6,
            "https://github.com/ruby-grape/grape/issues/1762": 5,
            "https://github.com/ruby-grape/grape/pull/1763": 4,
            "https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax": 4,
            "http://example.com/api/endpoint?format=%3Cscript%3Ealert(document.cookie)%3C/script%3E": 4,
            "https://github.com/features/actions": 2,
            "https://github.com/features/packages": 2,
            "https://github.com/features/security": 2,
            "https://github.com/features/codespaces": 2,
            "https://github.com/features/copilot": 2,
            "https://github.com/features/code-review": 2,
            "https://github.com/features/issues": 2,
            "https://github.com/features/discussions": 2,
            "https://github.com/features": 2,
            "https://docs.github.com": 2,
            "https://skills.github.com": 2,
            "https://github.blog": 2,
            "https://github.com/enterprise": 2,
            "https://github.com/team": 2,
            "https://github.com/enterprise/startups": 2,
            "https://github.com/solutions/industries/healthcare": 2,
            "https://github.com/solutions/industries/financial-services": 2,
            "https://github.com/solutions/industries/manufacturing": 2,
            "https://github.com/solutions/ci-cd": 2,
            "https://github.com/solutions/devops": 2,
            "https://github.com/solutions/devsecops": 2,
            "https://resources.github.com/learn/pathways": 2,
            "https://resources.github.com": 2,
            "https://github.com/customer-stories": 2,
            "https://partner.github.com": 2,
            "https://github.com/readme": 2,
            "https://github.com/topics": 2,
            "https://github.com/trending": 2,
            "https://github.com/collections": 2,
            "https://github.com/enterprise/advanced-security": 2,
            "https://github.com/pricing": 2,
            "https://docs.github.com/terms": 2,
            "https://docs.github.com/privacy": 2,
            "https://github.com": 2,
            "https://docs.github.com/site-policy/github-terms/github-terms-of-service": 2,
            "https://docs.github.com/site-policy/privacy-policies/github-privacy-statement": 2,
            "https://github.com/security": 2,
            "https://www.githubstatus.com/": 2,
            "https://docs.github.com/": 2,
            "https://support.github.com?tags=dotcom-footer": 2,
            "commit::e209ec029ddd03a1e195a1405249cf07ebe3edee": 2,
            "commit::680d6880d6e265200e04949b0a05b78c43bc5546": 2,
            "commit::3c503b6d47c9dd75287744dc2eb707f24766a2b9": 2,
            "commit::477f3302077ca19cad729099a51e251d1ec1eb5f": 2,
            "https://github.com/ruby-grape/grape/issues/322": 1,
            "https://github.co/hiddenchars": 1,
            "https://github.com/dblock": 1,
            "https://github.com/ruby-grape/grape/pull/1763#event-1647692415": 1,
            "https://nvd.nist.gov/vuln/detail/CVE-2018-3769": 1,
            "https://github.com/Kukunin": 1
        },
        "affected_products": [
            "ruby-grape ruby gem",
            "XSS"
        ],
        "versions": {
            "status": "affected",
            "version": ">= 1.0.3"
        },
        "files": [
            "XSS",
            "ruby-grape",
            "cross-site"
        ],
        "keywords": [
            "format",
            "ruby",
            "scripting",
            "grape",
            "vulnerability",
            "suffer",
            "parameter"
        ],
        "files_extension": [],
        "has_fixing_commit": true
    },
    "commits": [
        {
            "commit_id": "6876b71efc7b03f7ce1be3f075eaa4e7e6de19af",
            "repository": "https://github.com/ruby-grape/grape",
            "timestamp": 1527296865,
            "hunks": 7,
            "message": "When returning an HTML error, make sure it's safe (#1763) * When calling into an API specifying a crafted format that is HTML, the returned error renders the HTML back to the user, causing a potential XSS issue.  For example: http://example.com/api/endpoint?format=%3Cscript%3Ealert(document.cookie)%3C/script%3E Renders as html: The requested format '<script>alert(document.cookie)</script>' is not supported. When an error generates html back to the user, make sure it's properly escaped. Fixes issue #1762 * Add changelog entry * Use a method that also works in rails3 * Add spec formatting for older rails/activesupport version",
            "diff": [
                "diff --git a/lib/grape/middleware/error.rb b/lib/grape/middleware/error.rb",
                "index f7216494..0991b488 100644",
                "--- a/lib/grape/middleware/error.rb",
                "+++ b/lib/grape/middleware/error.rb",
                "@@ -1,2 +1,3 @@",
                " require 'grape/middleware/base'",
                "+require 'active_support/core_ext/string/output_safety'",
                "@@ -71,2 +72,5 @@ module Grape",
                "       def rack_response(message, status = options[:default_status], headers = { Grape::Http::Headers::CONTENT_TYPE => content_type })",
                "+        if headers[Grape::Http::Headers::CONTENT_TYPE] == TEXT_HTML",
                "+          message = ERB::Util.html_escape(message)",
                "+        end",
                "         Rack::Response.new([message], status, headers).finish",
                "diff --git a/spec/grape/api_spec.rb b/spec/grape/api_spec.rb",
                "index 82c50246..c38205f4 100644",
                "--- a/spec/grape/api_spec.rb",
                "+++ b/spec/grape/api_spec.rb",
                "@@ -2144,3 +2144,7 @@ XML",
                "       expect(last_response.status).to eq(406)",
                "-      expect(last_response.body).to eq(\"The requested format 'txt' is not supported.\")",
                "+      if ActiveSupport::VERSION::MAJOR == 3",
                "+        expect(last_response.body).to eq('The requested format &#x27;txt&#x27; is not supported.')",
                "+      else",
                "+        expect(last_response.body).to eq('The requested format &#39;txt&#39; is not supported.')",
                "+      end",
                "     end",
                "@@ -3526,3 +3530,23 @@ XML",
                "       expect(last_response.status).to eq(406)",
                "-      expect(last_response.body).to eq(\"{\\\"error\\\":\\\"The requested format 'txt' is not supported.\\\"}\")",
                "+      if ActiveSupport::VERSION::MAJOR == 3",
                "+        expect(last_response.body).to eq('{&quot;error&quot;:&quot;The requested format &#x27;txt&#x27; is not supported.&quot;}')",
                "+      else",
                "+        expect(last_response.body).to eq('{&quot;error&quot;:&quot;The requested format &#39;txt&#39; is not supported.&quot;}')",
                "+      end",
                "+    end",
                "+  end",
                "+",
                "+  context 'with unsafe HTML format specified' do",
                "+    it 'escapes the HTML' do",
                "+      subject.content_type :json, 'application/json'",
                "+      subject.get '/something' do",
                "+        'foo'",
                "+      end",
                "+      get '/something?format=<script>blah</script>'",
                "+      expect(last_response.status).to eq(406)",
                "+      if ActiveSupport::VERSION::MAJOR == 3",
                "+        expect(last_response.body).to eq('The requested format &#x27;&lt;script&gt;blah&lt;/script&gt;&#x27; is not supported.')",
                "+      else",
                "+        expect(last_response.body).to eq('The requested format &#39;&lt;script&gt;blah&lt;/script&gt;&#39; is not supported.')",
                "+      end",
                "     end",
                "diff --git a/spec/grape/middleware/exception_spec.rb b/spec/grape/middleware/exception_spec.rb",
                "index 2f65cc54..c11b4964 100644",
                "--- a/spec/grape/middleware/exception_spec.rb",
                "+++ b/spec/grape/middleware/exception_spec.rb",
                "@@ -194,3 +194,3 @@ describe Grape::Middleware::Error do",
                "       get '/'",
                "-      expect(last_response.body).to eq('{\"error\":\"rain!\"}')",
                "+      expect(last_response.body).to eq('{&quot;error&quot;:&quot;rain!&quot;}')",
                "     end",
                "@@ -209,4 +209,4 @@ describe Grape::Middleware::Error do",
                "       get '/'",
                "-      expect(['{\"error\":\"rain!\",\"detail\":\"missing widget\"}',",
                "-              '{\"detail\":\"missing widget\",\"error\":\"rain!\"}']).to include(last_response.body)",
                "+      expect(['{&quot;error&quot;:&quot;rain!&quot;,&quot;detail&quot;:&quot;missing widget&quot;}',",
                "+              '{&quot;detail&quot;:&quot;missing widget&quot;,&quot;error&quot;:&quot;rain!&quot;}']).to include(last_response.body)",
                "     end",
                "@@ -260,3 +260,3 @@ describe Grape::Middleware::Error do",
                "       get '/'",
                "-      expect(last_response.body).to eq('{:custom_formatter=>\"rain!\"}')",
                "+      expect(last_response.body).to eq('{:custom_formatter=&gt;&quot;rain!&quot;}')",
                "     end"
            ],
            "changed_files": [
                "lib/grape/middleware/error.rb",
                "spec/grape/api_spec.rb",
                "spec/grape/middleware/exception_spec.rb"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {
                "1763": "Default formatter error can cause XSS rendering issue #1762 fixed the grape advisory rubysec/ruby-advisory-db#349 JSON errors get escaped #1859",
                "1762": "When returning an HTML error, make sure it's safe #1763"
            },
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v1.1.0",
                "v1.2.0",
                "v1.2.1",
                "v1.2.2",
                "v1.2.3",
                "v1.2.4",
                "v1.2.5",
                "v1.3.0",
                "v1.3.1",
                "v1.3.2",
                "v1.3.3",
                "v1.4.0",
                "v1.5.0",
                "v1.5.1",
                "v1.5.2",
                "v1.5.3",
                "v1.6.0",
                "v1.6.1",
                "v1.6.2",
                "v1.7.0",
                "v1.7.1",
                "v1.8.0",
                "v2.0.0",
                "v2.1.0",
                "v2.1.1",
                "v2.1.2"
            ],
            "matched_rules": [
                {
                    "id": "XREF_GH",
                    "message": "The commit and the advisory (including referenced pages) mention the same github issue: 1763, 1762",
                    "relevance": 32
                },
                {
                    "id": "COMMIT_IN_REFERENCE",
                    "message": "This commit is mentioned 6 times in the references.",
                    "relevance": 64
                },
                {
                    "id": "RELEVANT_WORDS_IN_MESSAGE",
                    "message": "The commit message contains some relevant words: XSS",
                    "relevance": 8
                },
                {
                    "id": "SEC_KEYWORDS_IN_LINKED_GH",
                    "message": "The github issue 1763 contains some security-related terms: xss",
                    "relevance": 4
                },
                {
                    "id": "SEC_KEYWORDS_IN_MESSAGE",
                    "message": "The commit message contains some security-related keywords: xss",
                    "relevance": 4
                },
                {
                    "id": "ADV_KEYWORDS_IN_MSG",
                    "message": "The commit message and the advisory description contain the following keywords: format",
                    "relevance": 4
                },
                {
                    "id": "GITHUB_ISSUE_IN_MESSAGE",
                    "message": "The commit message references some github issue: 1763, 1762",
                    "relevance": 2
                }
            ]
        },
        {
            "commit_id": "d845a3aa525fcaec09dce65901cd9ed0cee2a0aa",
            "repository": "https://github.com/ruby-grape/grape",
            "timestamp": 1527684470,
            "hunks": 0,
            "message": "Merge pull request #1764 from budnik/patch-1 Fixes examples syntax",
            "diff": [],
            "changed_files": [],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {
                "1764": ""
            },
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v1.1.0",
                "v1.2.0",
                "v1.2.1",
                "v1.2.2",
                "v1.2.3",
                "v1.2.4",
                "v1.2.5",
                "v1.3.0",
                "v1.3.1",
                "v1.3.2",
                "v1.3.3",
                "v1.4.0",
                "v1.5.0",
                "v1.5.1",
                "v1.5.2",
                "v1.5.3",
                "v1.6.0",
                "v1.6.1",
                "v1.6.2",
                "v1.7.0",
                "v1.7.1",
                "v1.8.0",
                "v2.0.0",
                "v2.1.0",
                "v2.1.1",
                "v2.1.2"
            ],
            "matched_rules": [
                {
                    "id": "GITHUB_ISSUE_IN_MESSAGE",
                    "message": "The commit message references some github issue: 1764",
                    "relevance": 2
                }
            ]
        }
    ]
}
