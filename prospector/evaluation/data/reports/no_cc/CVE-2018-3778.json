{
    "advisory_record": {
        "cve_id": "CVE-2018-3778",
        "description": "Improper authorization in aedes version <0.35.0 will publish a LWT in a channel when a client is not authorized.",
        "reserved_timestamp": 1514419200,
        "published_timestamp": 1533513600,
        "updated_timestamp": 1534255021,
        "repository_url": null,
        "references": {
            "": 218,
            "https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax": 6,
            "commit::a02f55496eceae66406bbdf64685c2b7069a586b": 6,
            "commit::11f6a428e072d43d1458180c1fe5212a07cb8d5c": 6,
            "https://github.com/moscajs/aedes/issues/211": 4,
            "https://github.com/features/actions": 3,
            "https://github.com/features/packages": 3,
            "https://github.com/features/security": 3,
            "https://github.com/features/codespaces": 3,
            "https://github.com/features/copilot": 3,
            "https://github.com/features/code-review": 3,
            "https://github.com/features/issues": 3,
            "https://github.com/features/discussions": 3,
            "https://github.com/features": 3,
            "https://docs.github.com": 3,
            "https://skills.github.com": 3,
            "https://github.blog": 3,
            "https://github.com/enterprise": 3,
            "https://github.com/team": 3,
            "https://github.com/enterprise/startups": 3,
            "https://github.com/solutions/industries/healthcare": 3,
            "https://github.com/solutions/industries/financial-services": 3,
            "https://github.com/solutions/industries/manufacturing": 3,
            "https://github.com/solutions/ci-cd": 3,
            "https://github.com/solutions/devops": 3,
            "https://github.com/solutions/devsecops": 3,
            "https://resources.github.com/learn/pathways": 3,
            "https://resources.github.com": 3,
            "https://github.com/customer-stories": 3,
            "https://partner.github.com": 3,
            "https://github.com/readme": 3,
            "https://github.com/topics": 3,
            "https://github.com/trending": 3,
            "https://github.com/collections": 3,
            "https://github.com/enterprise/advanced-security": 3,
            "https://github.com/pricing": 3,
            "https://github.com": 3,
            "https://docs.github.com/site-policy/github-terms/github-terms-of-service": 3,
            "https://docs.github.com/site-policy/privacy-policies/github-privacy-statement": 3,
            "https://github.com/security": 3,
            "https://www.githubstatus.com/": 3,
            "https://docs.github.com/": 3,
            "https://support.github.com?tags=dotcom-footer": 3,
            "https://github.com/nodejs/security-wg/blob/master/vuln/npm/457.json": 2,
            "https://github.com/mcollina/aedes/issues/212": 2,
            "https://github.com/mcollina/aedes/issues/211": 2,
            "https://docs.github.com/terms": 2,
            "https://docs.github.com/privacy": 2,
            "https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment": 2,
            "commit::ffbc1702bb24b596afbb96407cc6db234a4044a8": 2,
            "https://github.com/mhverbakel": 2,
            "https://github.com/mcollina": 2,
            "https://github.com/nodejs/security-wg/raw/main/vuln/npm/457.json": 1,
            "https://github.co/hiddenchars": 1,
            "https://github.com/moscajs/aedes/pull/212#event-1774528679": 1,
            "https://github.com/nguyenthenguyen": 1,
            "https://github.com/moscajs/aedes/pull/213": 1,
            "https://github.com/moscajs/aedes/issues/211#issuecomment-410800575": 1
        },
        "affected_products": [
            "version",
            "aedes"
        ],
        "versions": {
            "status": "affected",
            "version": ">=0.35.1"
        },
        "files": [
            "LWT"
        ],
        "keywords": [
            "authorization",
            "authorize",
            "channel",
            "publish",
            "client",
            "version",
            "aedes"
        ],
        "files_extension": [],
        "has_fixing_commit": true
    },
    "commits": [
        {
            "commit_id": "ffbc1702bb24b596afbb96407cc6db234a4044a8",
            "repository": "https://github.com/mcollina/aedes",
            "timestamp": 1533625947,
            "hunks": 4,
            "message": "Fix #211 (#212) * Added test cases for #211. * Fixed #211.",
            "diff": [
                "diff --git a/lib/client.js b/lib/client.js",
                "index 644589d..75464ef 100644",
                "--- a/lib/client.js",
                "+++ b/lib/client.js",
                "@@ -244,8 +244,16 @@ Client.prototype.close = function (done) {",
                "     if (!that.disconnected && that.will) {",
                "-      that.broker.publish(that.will, that, function (err) {",
                "+      that.broker.authorizePublish(that, that.will, function (err) {",
                "         if (!err) {",
                "-          that.broker.persistence.delWill({",
                "-            id: that.id,",
                "-            brokerId: that.broker.id",
                "-          }, nop)",
                "+          that.broker.publish(that.will, that, done)",
                "+        } else {",
                "+          done()",
                "+        }",
                "+",
                "+        function done (err) {",
                "+          if (!err) {",
                "+            that.broker.persistence.delWill({",
                "+              id: that.id,",
                "+              brokerId: that.broker.id",
                "+            }, nop)",
                "+          }",
                "         }",
                "@@ -300,2 +308,2 @@ function enqueue (packet) {",
                "-function nop () {}",
                "+function nop () { }",
                "diff --git a/test/will.js b/test/will.js",
                "index 0c5bf08..8caa218 100644",
                "--- a/test/will.js",
                "+++ b/test/will.js",
                "@@ -163 +163,42 @@ test('delete the will in the persistence after publish', function (t) {",
                " })",
                "+",
                "+test('delivers a will with authorization', function (t) {",
                "+  let authorized = false",
                "+  var opts = {}",
                "+  // willConnect populates opts with a will",
                "+  var s = willConnect(setup(aedes({ authorizePublish: (_1, _2, callback) => { authorized = true; callback(null) } })), opts)",
                "+",
                "+  s.broker.on('clientDisconnect', function () {",
                "+    t.end()",
                "+  })",
                "+",
                "+  s.broker.mq.on('mywill', function (packet, cb) {",
                "+    t.equal(packet.topic, opts.will.topic, 'topic matches')",
                "+    t.deepEqual(packet.payload, opts.will.payload, 'payload matches')",
                "+    t.equal(packet.qos, opts.will.qos, 'qos matches')",
                "+    t.equal(packet.retain, opts.will.retain, 'retain matches')",
                "+    t.equal(authorized, true, 'authorization called')",
                "+    cb()",
                "+  })",
                "+",
                "+  s.conn.destroy()",
                "+})",
                "+",
                "+test('does not deliver a will without authorization', function (t) {",
                "+  let authorized = false",
                "+  var opts = {}",
                "+  // willConnect populates opts with a will",
                "+  var s = willConnect(setup(aedes({ authorizePublish: (_1, _2, callback) => { authorized = true; callback(new Error()) } })), opts)",
                "+",
                "+  s.broker.on('clientDisconnect', function () {",
                "+    t.equal(authorized, true, 'authorization called')",
                "+    t.end()",
                "+  })",
                "+",
                "+  s.broker.mq.on('mywill', function (packet, cb) {",
                "+    t.fail('received will without authorization')",
                "+    cb()",
                "+  })",
                "+",
                "+  s.conn.destroy()",
                "+})"
            ],
            "changed_files": [
                "lib/client.js",
                "test/will.js"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {
                "211": "Adding a security vulnerability that was disclosed in the public nodejs/security-wg#371 Fix #211 #212 \ud83d\udea8 [security] Update aedes: 0.35.0 \u2192 0.35.2 (minor) depfutest/devfu-npm-vulnerable#1",
                "212": "Adding a security vulnerability that was disclosed in the public nodejs/security-wg#371 \ud83d\udea8 [security] Update aedes: 0.35.0 \u2192 0.35.2 (minor) depfutest/devfu-npm-vulnerable#1"
            },
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v0.35.1",
                "v0.35.2",
                "v0.35.3",
                "v0.36.0",
                "v0.37.0",
                "v0.38.0",
                "v0.38.1",
                "v0.39.0",
                "v0.40.0",
                "v0.40.1",
                "v0.41.0",
                "v0.42.0",
                "v0.42.1",
                "v0.42.2",
                "v0.42.3",
                "v0.42.4",
                "v0.42.5",
                "v0.42.6",
                "v0.43.0",
                "v0.44.0",
                "v0.44.1",
                "v0.44.2",
                "v0.45.0",
                "v0.45.1",
                "v0.45.2",
                "v0.46.0",
                "v0.46.1",
                "v0.46.2",
                "v0.46.3",
                "v0.47.0",
                "v0.48.0",
                "v0.48.1",
                "v0.49.0",
                "v0.50.0",
                "v0.50.1",
                "v0.51.0",
                "v0.51.1",
                "v0.51.2"
            ],
            "matched_rules": [
                {
                    "id": "XREF_GH",
                    "message": "The commit and the advisory (including referenced pages) mention the same github issue: 211, 212",
                    "relevance": 32
                },
                {
                    "id": "COMMIT_IN_REFERENCE",
                    "message": "This commit is mentioned 2 times in the references.",
                    "relevance": 64
                },
                {
                    "id": "SEC_KEYWORDS_IN_LINKED_GH",
                    "message": "The github issue 211 contains some security-related terms: vulnerability, security",
                    "relevance": 4
                },
                {
                    "id": "ADV_KEYWORDS_IN_FILES",
                    "message": "An advisory keyword is contained in the changed files: client",
                    "relevance": 4
                },
                {
                    "id": "GITHUB_ISSUE_IN_MESSAGE",
                    "message": "The commit message references some github issue: 211, 212",
                    "relevance": 2
                }
            ]
        },
        {
            "commit_id": "09f0070a7aa2f5ac24a379092d6fb78ecb4315aa",
            "repository": "https://github.com/mcollina/aedes",
            "timestamp": 1534155411,
            "hunks": 3,
            "message": "delivers a will waits for authorization (#213) * delivers a will waits for authorization * set will to null should after check error * prevent finish func in client.js might be called twice * copy that.will to into the context of the closure of function authorizePublish and use setImmediate instead of setTimeout in will test",
            "diff": [
                "diff --git a/lib/client.js b/lib/client.js",
                "index 75464ef..367878a 100644",
                "--- a/lib/client.js",
                "+++ b/lib/client.js",
                "@@ -244,5 +244,6 @@ Client.prototype.close = function (done) {",
                "     if (!that.disconnected && that.will) {",
                "-      that.broker.authorizePublish(that, that.will, function (err) {",
                "+      var will = Object.assign({}, that.will)",
                "+      that.broker.authorizePublish(that, will, function (err) {",
                "         if (!err) {",
                "-          that.broker.publish(that.will, that, done)",
                "+          that.broker.publish(will, that, done)",
                "         } else {",
                "diff --git a/test/will.js b/test/will.js",
                "index 8caa218..a920729 100644",
                "--- a/test/will.js",
                "+++ b/test/will.js",
                "@@ -186,2 +186,24 @@ test('delivers a will with authorization', function (t) {",
                "+test('delivers a will waits for authorization', function (t) {",
                "+  let authorized = false",
                "+  var opts = {}",
                "+  // willConnect populates opts with a will",
                "+  var s = willConnect(setup(aedes({ authorizePublish: (_1, _2, callback) => { authorized = true; setImmediate(() => { callback(null) }) } })), opts)",
                "+",
                "+  s.broker.on('clientDisconnect', function () {",
                "+    t.end()",
                "+  })",
                "+",
                "+  s.broker.mq.on('mywill', function (packet, cb) {",
                "+    t.equal(packet.topic, opts.will.topic, 'topic matches')",
                "+    t.deepEqual(packet.payload, opts.will.payload, 'payload matches')",
                "+    t.equal(packet.qos, opts.will.qos, 'qos matches')",
                "+    t.equal(packet.retain, opts.will.retain, 'retain matches')",
                "+    t.equal(authorized, true, 'authorization called')",
                "+    cb()",
                "+  })",
                "+",
                "+  s.conn.destroy()",
                "+})",
                "+",
                " test('does not deliver a will without authorization', function (t) {"
            ],
            "changed_files": [
                "lib/client.js",
                "test/will.js"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {
                "213": "Fix #211 #212"
            },
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v0.35.2",
                "v0.35.3",
                "v0.36.0",
                "v0.37.0",
                "v0.38.0",
                "v0.38.1",
                "v0.39.0",
                "v0.40.0",
                "v0.40.1",
                "v0.41.0",
                "v0.42.0",
                "v0.42.1",
                "v0.42.2",
                "v0.42.3",
                "v0.42.4",
                "v0.42.5",
                "v0.42.6",
                "v0.43.0",
                "v0.44.0",
                "v0.44.1",
                "v0.44.2",
                "v0.45.0",
                "v0.45.1",
                "v0.45.2",
                "v0.46.0",
                "v0.46.1",
                "v0.46.2",
                "v0.46.3",
                "v0.47.0",
                "v0.48.0",
                "v0.48.1",
                "v0.49.0",
                "v0.50.0",
                "v0.50.1",
                "v0.51.0",
                "v0.51.1",
                "v0.51.2"
            ],
            "matched_rules": [
                {
                    "id": "ADV_KEYWORDS_IN_MSG",
                    "message": "The commit message and the advisory description contain the following keywords: authorization, authorize, publish, client",
                    "relevance": 4
                },
                {
                    "id": "ADV_KEYWORDS_IN_FILES",
                    "message": "An advisory keyword is contained in the changed files: client",
                    "relevance": 4
                },
                {
                    "id": "GITHUB_ISSUE_IN_MESSAGE",
                    "message": "The commit message references some github issue: 213",
                    "relevance": 2
                }
            ]
        },
        {
            "commit_id": "12392f4516ecc2e0491dbc832255c30ed7a5edff",
            "repository": "https://github.com/mcollina/aedes",
            "timestamp": 1533626433,
            "hunks": 1,
            "message": "Bumped v0.35.1.",
            "diff": [
                "diff --git a/package.json b/package.json",
                "index 5824060..25291e0 100644",
                "--- a/package.json",
                "+++ b/package.json",
                "@@ -2,3 +2,3 @@",
                "   \"name\": \"aedes\",",
                "-  \"version\": \"0.35.0\",",
                "+  \"version\": \"0.35.1\",",
                "   \"description\": \"Stream-based MQTT broker\","
            ],
            "changed_files": [
                "package.json"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {},
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v0.35.1",
                "v0.35.2",
                "v0.35.3",
                "v0.36.0",
                "v0.37.0",
                "v0.38.0",
                "v0.38.1",
                "v0.39.0",
                "v0.40.0",
                "v0.40.1",
                "v0.41.0",
                "v0.42.0",
                "v0.42.1",
                "v0.42.2",
                "v0.42.3",
                "v0.42.4",
                "v0.42.5",
                "v0.42.6",
                "v0.43.0",
                "v0.44.0",
                "v0.44.1",
                "v0.44.2",
                "v0.45.0",
                "v0.45.1",
                "v0.45.2",
                "v0.46.0",
                "v0.46.1",
                "v0.46.2",
                "v0.46.3",
                "v0.47.0",
                "v0.48.0",
                "v0.48.1",
                "v0.49.0",
                "v0.50.0",
                "v0.50.1",
                "v0.51.0",
                "v0.51.1",
                "v0.51.2"
            ],
            "matched_rules": []
        },
        {
            "commit_id": "fdae622798d996aa6c556c83612a5437e782a760",
            "repository": "https://github.com/mcollina/aedes",
            "timestamp": 1534155817,
            "hunks": 6,
            "message": "Updated dependencies",
            "diff": [
                "diff --git a/package.json b/package.json",
                "index 25291e0..d1d3877 100644",
                "--- a/package.json",
                "+++ b/package.json",
                "@@ -40,3 +40,3 @@",
                "   \"devDependencies\": {",
                "-    \"@types/node\": \"^8.10.0\",",
                "+    \"@types/node\": \"^8.10.25\",",
                "     \"compute-mode\": \"^1.0.0\",",
                "@@ -44,3 +44,3 @@",
                "     \"convert-hrtime\": \"^2.0.0\",",
                "-    \"coveralls\": \"^3.0.1\",",
                "+    \"coveralls\": \"^3.0.2\",",
                "     \"duplexify\": \"^3.6.0\",",
                "@@ -48,3 +48,3 @@",
                "     \"istanbul\": \"^0.4.1\",",
                "-    \"mqtt\": \"^2.18.0\",",
                "+    \"mqtt\": \"^2.18.3\",",
                "     \"mqtt-connection\": \"^3.2.0\",",
                "@@ -52,6 +52,6 @@",
                "     \"standard\": \"^11.0.0\",",
                "-    \"tape\": \"^4.9.0\",",
                "-    \"tslint\": \"^5.10.0\",",
                "-    \"tslint-config-standard\": \"^7.0.0\",",
                "-    \"typescript\": \"^2.8.3\",",
                "+    \"tape\": \"^4.9.1\",",
                "+    \"tslint\": \"^5.11.0\",",
                "+    \"tslint-config-standard\": \"^7.1.0\",",
                "+    \"typescript\": \"^2.9.2\",",
                "     \"websocket-stream\": \"^5.1.2\"",
                "@@ -73,5 +73,5 @@",
                "     \"safe-buffer\": \"^5.1.2\",",
                "-    \"shortid\": \"^2.1.3\",",
                "+    \"shortid\": \"^2.2.12\",",
                "     \"through2\": \"^2.0.0\",",
                "-    \"uuid\": \"^3.2.1\",",
                "+    \"uuid\": \"^3.3.2\",",
                "     \"xtend\": \"^4.0.1\""
            ],
            "changed_files": [
                "package.json"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {},
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v0.35.2",
                "v0.35.3",
                "v0.36.0",
                "v0.37.0",
                "v0.38.0",
                "v0.38.1",
                "v0.39.0",
                "v0.40.0",
                "v0.40.1",
                "v0.41.0",
                "v0.42.0",
                "v0.42.1",
                "v0.42.2",
                "v0.42.3",
                "v0.42.4",
                "v0.42.5",
                "v0.42.6",
                "v0.43.0",
                "v0.44.0",
                "v0.44.1",
                "v0.44.2",
                "v0.45.0",
                "v0.45.1",
                "v0.45.2",
                "v0.46.0",
                "v0.46.1",
                "v0.46.2",
                "v0.46.3",
                "v0.47.0",
                "v0.48.0",
                "v0.48.1",
                "v0.49.0",
                "v0.50.0",
                "v0.50.1",
                "v0.51.0",
                "v0.51.1",
                "v0.51.2"
            ],
            "matched_rules": []
        },
        {
            "commit_id": "273fa45c4885b51904c0a7d93ba9b9e7571e7324",
            "repository": "https://github.com/mcollina/aedes",
            "timestamp": 1534155923,
            "hunks": 1,
            "message": "Bumped v0.35.2.",
            "diff": [
                "diff --git a/package.json b/package.json",
                "index d1d3877..5233a24 100644",
                "--- a/package.json",
                "+++ b/package.json",
                "@@ -2,3 +2,3 @@",
                "   \"name\": \"aedes\",",
                "-  \"version\": \"0.35.1\",",
                "+  \"version\": \"0.35.2\",",
                "   \"description\": \"Stream-based MQTT broker\","
            ],
            "changed_files": [
                "package.json"
            ],
            "message_reference_content": [],
            "jira_refs": {},
            "ghissue_refs": {},
            "cve_refs": [],
            "twins": [],
            "tags": [
                "v0.35.2",
                "v0.35.3",
                "v0.36.0",
                "v0.37.0",
                "v0.38.0",
                "v0.38.1",
                "v0.39.0",
                "v0.40.0",
                "v0.40.1",
                "v0.41.0",
                "v0.42.0",
                "v0.42.1",
                "v0.42.2",
                "v0.42.3",
                "v0.42.4",
                "v0.42.5",
                "v0.42.6",
                "v0.43.0",
                "v0.44.0",
                "v0.44.1",
                "v0.44.2",
                "v0.45.0",
                "v0.45.1",
                "v0.45.2",
                "v0.46.0",
                "v0.46.1",
                "v0.46.2",
                "v0.46.3",
                "v0.47.0",
                "v0.48.0",
                "v0.48.1",
                "v0.49.0",
                "v0.50.0",
                "v0.50.1",
                "v0.51.0",
                "v0.51.1",
                "v0.51.2"
            ],
            "matched_rules": []
        }
    ]
}
